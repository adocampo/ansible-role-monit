---

- name: Config | Create Includes and Lib Directories
  file:
    path: "{{ item }}"
    state: directory
    mode: 0775
    owner: "{{ monit_owner }}"
    group: "{{ monit_group }}"
  with_items:
    - "{{ monit_lib_folder }}"
    - "{{ monit_includes }}"
    - "{{ monit_log_dir }}"
    - "{{ monit_alert_defaults }}"

- name: create lib folder
  file: path="{{ monit_lib_folder }}" state=directory mode=0600


# Include variables and define needed variables.
- name: Include OS-specific tasks | Debian.
  include: Debian/pkg.yml
  tags: monit_pkg
  when: ansible_os_family == "Debian"

- name: Include OS-specific tasks | Redhat.
  include: RedHat/pkg.yml
  tags: monit_pkg
  when: ansible_os_family == "RedHat"

- name: create includes folder
  file:
    path: "{{ monit_includes }}"
    state: directory
    mode: 0600


- name: create id folder
  file:
    path: "{{ monit_id_folder }}"
    state: directory
    mode: 0600

- name: config - Setup monitrc
  template:
    src: monitrc.j2
    dest:  "{{ monitrc_conf }}"
    owner: "{{ monit_owner }}"
    group: "{{ monit_group }}"
    mode: 0700
  notify: restart monit

- name: Config | Stat /etc/monitrc
  stat:
    path: "{{ monit_dir }}rc"
  register: _etc_monitrc
  become: true

- name: Config | Remove /etc/monitrc if Not a Link
  file:
    path: "{{ monit_dir }}rc"
    state: absent
  become: true
  when: not _etc_monitrc.stat.islnk
  ignore_errors: yes

- name: Config | Link /etc/monit/monitrc to /etc/monitrc
  file:
    path: "{{ monit_dir }}rc"
    src: "{{ monit_dir }}/monitrc"
    state: link
  become: true
  when: not _etc_monitrc.stat.islnk or not _etc_monitrc.stat.exists
  ignore_errors: yes

- name: Config | Config | Setup Webinterface
  template:
    src: webinterface.j2
    dest: "{{ monit_includes }}/webinterface"
    owner: "{{ monit_owner }}"
    group: "{{ monit_group }}"
    mode: 0660
  notify: restart monit

- name: Config | Config | Setup Mail Alerts
  template:
    src: mail.j2
    dest: "{{ monit_includes }}/mail"
    owner: "{{ monit_owner }}"
    group: "{{ monit_group }}"
    mode: 0660
  notify: restart monit
  when: monit_mail_enabled

- name: Create logrotate entry for monit.log
  template:
    src: logrotate_monit.j2
    dest: "/etc/logrotate.d/monit"
    owner: root
    group: root
    mode: 0644
  become: true
  when: ansible_os_family == "Debian"

- name: Put up Slack integration file if required
  template:
    src: slack.rb.j2
    dest: "/etc/monit/slack.rb"
    owner: root
    group: root
    mode: 0744
  become: true

- name: Config | Config | Copy Over Alert Defaults
  copy:
    src: files/{{ item }}
    dest: "{{ monit_alert_defaults }}/{{ item }}"
    owner: "{{ monit_owner }}"
    group: "{{ monit_group }}"
    mode: 0660
  with_items:
    - '3_5_cycles'
    - '5_7_7_10_cycles'
  notify: restart monit
